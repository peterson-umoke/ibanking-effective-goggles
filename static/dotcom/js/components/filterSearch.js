define(["jquery","underscore","track","../util/url"],function(e,a,t,r){function n(a){var t=e(a),r=t.find("[data-filtersearch]");r.attr("data-action")&&(d=r.find("select"),f=t.find(".listings__loadmore-container"),u=t.find(".listings__loadmore-errormessage"),d.length>0&&(r.find(".js-filter-clear--no-submit").removeClass("hidden"),d.each(function(a,t){var n=e(t);n.parent().hasClass("select-wrapper")||c(n),n.off("change").on("change",function(){r.submit()})})),r.on("submit",function(e){e.preventDefault(),i(r)}),r.on("click",".js-filter-clear--no-submit",function(){d.each(function(a,t){var r=e(t),n=r.find("option:first-child").text();r.val(n),r.siblings(".holder").text(r.find("option:first-child").text())})}))}function i(n){var i=n.serialize(),s=n.attr("data-action"),c=n.parents("article"),d=c.find(".search-results"),f=c.find(".search-message"),u=c.find(".search-pagination");e.ajax({url:s+"?"+i,type:"GET",dataType:"html"}).done(function(i){d.replaceWith(e(i).find(".search-results")),f.replaceWith(e(i).find(".search-message")[0]),u.replaceWith(e(i).find(".search-pagination")),o(i);var s=n.clone(!0);s.find('input[name="listingComponentIdKey"]').remove(),s.find('input[name="listingTemplateIdKey"]').remove();var c=s.serialize(),h=l(s);history.pushState&&r.replaceParams(c),a.isEmpty(h)||t(h)}).error(function(){})}function s(e,a){return""!==e?[a,e]:[]}function l(t){var r=[],n=t.serializeArray(),i=a.map(n,function(a){switch(a.name){case"fQ":return s(a.value,"wa_search_filter_query");case"fYear":return s(a.value,"wa_search_filter_year");case"fLang":return s(a.value,"wa_search_filter_language");case"fTopic":return s(a.value,"wa_search_filter_category");case"fPerson":return s(a.value,"wa_search_filter_person");case"fCat":if(""!==a.value){var t=e('option[value="'+a.value+'"]').text(),n=a.value+" "+t;n=n.replace(/tcm:/gm,""),r=["wa_search_filter_category",n]}return r;case"fSubCat":if(""!==a.value){var i=e('option[value="'+a.value+'"]').text(),l=a.value+" "+i;l=l.replace(/tcm:/gm,""),r[1]+="|"+l}return r}}),l=a.filter(i,function(e){return""!==e[1]});return a.object(l)}function c(a){var t=e(a);t.wrap('<span class="select-wrapper"></span>'),t.after('<span class="holder"></span>')}function o(a){d.each(function(t,r){var n=e(r),i=e(r).attr("name"),s=e(a).find('select[name="'+i+'"]'),l=e(a).find(".listings__loadmore-container").find("button"),c=s.find("option"),o=c.filter(":selected").text(),d=f.find("button");if(l.length>0){var h=l.html(),p=l.attr("data-action"),m=l.attr("data-query-parameters");d.removeClass("hidden"),d.html(h),d.attr("data-action",p),d.attr("data-query-parameters",m)}else d.hasClass("hidden")||d.addClass("hidden");u.empty(),0==s.length?n.parent().hide():n.parent().show(),n.html(s.html());var v=n.find("option");n.siblings(".holder").text(o),n.prop("disabled")&&v.length>2?(n.removeAttr("disabled"),n.parent().removeClass("disabled")):v.length<2&&(n.attr("disabled","disable"),n.parent().addClass("disabled"))})}var d,f,u;return n});